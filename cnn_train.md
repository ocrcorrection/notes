# 一、训练一阶段

## **1 数据**

### **1.1 汉字**

3900个常用汉字，其中包括一个空格

|        | 最常用字       | 较常用字       | 最不常用字     | 总数    |
| ------ | -------------- | -------------- | -------------- | ------- |
| 总数   | 1000           | 1000           | 1900           |         |
| 训练集 | 2000*1000(62M) | 1500*1000(47M) | 1000*1900()    | 5400000 |
| 测试集 | 200*1000(6.2M) | 150*1000(4.7M) | 100*1900(5.9M) | 540000  |

### **1.2 标点符号**

| 总数 | 训练集  | 测试集 |
| ---- | ------- | :----- |
| 29   | 29*2000 | 29*100 |
|      | 58000   | 2900   |

### **1.3 数字字母**

| 总数 | 训练集  | 测试集 |
| ---- | ------- | :----- |
| 62   | 62*2000 | 62*100 |
|      | 124000  | 6200   |

### **1.4 总数据**

训练集：5400000+58000+124000= 5582000

测试集：540000+2900+6200 = 549100

## **2 数据存放**

- 38服务器 290端口
- /usr/local/src/data/stage3/all_3991

## **3 模型结构**

| **Layer**          | **1**                         | **2** | **3** | **4** | **全连接层** | **逻辑层** |
| ------------------ | ----------------------------- | ----- | ----- | ----- | ---- | ---- |
| **inputs**         | **64*64**                     |       |       |       |      |      |
| **filters**        | **32**                        | **64** | **128** | **256** |      |      |
| **kernel_size**    | **3**                                                        ||||||
| **padding**        | **same**                                                     ||||||
| **kernel_initializer** | **tf.glorot_uniform_initializer**                            ||||||
| **归一化**         | **batch_normalization**       |       |       |       |      |      |
| **激活**           | **leaky_relu**                |       |       |       |      |      |
| **池化**           | **pool_size=[2, 2], strides=2** |       |       |       |      |      |
| **units** |                               |       |       |       | **8192** | **num_class** |
|  | | | | |  |  |

## **4 模型预测**

### **4.1 预测数据**

**147电脑上**：/usr/local/src/data/test_data/test_data/input_data

- 8张像素较好的的图片

- 预测结果在：/usr/local/src/data/test_data/test_data/output_data

  > 结果包含，预测生成的文本，每个字，预测的概率值

**290服务器上：**

- 详细见：configs/single_char_3991_infer.yaml

**147电脑上**：/usr/local/src/data/stage3/documents 【刘宇翔数据】

- [x] 裁定书 tCDS （966）【大多是民事裁定书， 图片较歪， 需要进行角度纠正】
- [x] 律师事务所函 tLSSWSH （505）【包含很多手写体，章，质量不是很好】
- [x] 判决书 tPJS （882）【大多是民事判决书， 图片较歪】
- [x] 上诉状 tQSZ （733）【各种上诉状，字体很多很小】
- [x] 申请书 tSQH （992）【包括很多异议书， 无申请书字样，字体很多很小】
- [x] 授权委托书 tSQWTS（1174）【很多有下划线，手写体，图片质量层析不齐】
- [x] 调解笔录 tTJBL（447）【手写体很多，质量不是很好】
- [x] 调解书 tTJS （976）【图片质量层析不齐，大多质量不错】
- [x] 宣判笔录 tXPBL（1260）【不清晰，章，手写体，图片质量层析不齐】



**147电脑上：**/usr/local/src/data/doc_imgs





| 卷宗                 | 匹配                                 | 准确率             |
| -------------------- | ------------------------------------ | ------------------ |
| 上诉状 tQSZ          | 上诉\|起诉\|诉                       | 92.0%              |
| 宣判笔录 tXPBL       | 宣判笔录\|笔录\|判笔                 | 95.6%              |
| 调解笔录 tTJBL       | 调解笔录\|笔录\|解笔                 | 92.7%(343, 318)    |
| 裁定书 tCDS          | 裁定书\|定书\|裁                     | 90%(126,140)       |
| 律师事务所函 tLSSWSH | 律师事务所\|事务所\|师事\|务所\|事务 | 96.5%              |
| 判决书 tPJS          | 判决书\|决书\|判决                   | 88.8%（127,143）   |
| 申请书 tSQH          | 申请书\|申请\|情书                   | 89.7%(35, 39)      |
| 授权委托书 tSQWTS    | 授权委托书\|委托书\|托书\|委托       | 93.5%（29，31）    |
| 调解书 tTJS          | 调解书\|调解\|解书                   | 89.8%（559， 502） |













| 卷宗                 | 匹配                                 | ours准确率 | ts准确率 |
| -------------------- | ------------------------------------ | ---------- | -------- |
| 上诉状 tQSZ          | 上诉\|起诉\|诉                       | 92.0%      | 93.2%    |
| 宣判笔录 tXPBL       | 宣判笔录\|笔录\|判笔                 | 95.6%      | 94.2%    |
| 调解笔录 tTJBL       | 调解笔录\|笔录\|解笔                 | 92.7%      | 94.9%    |
| 裁定书 tCDS          | 裁定书\|定书\|裁                     | 90%        | 95.8%    |
| 律师事务所函 tLSSWSH | 律师事务所\|事务所\|师事\|务所\|事务 | 96.5%      | 95.1%    |
| 判决书 tPJS          | 判决书\|决书\|判决                   | 88.8%      | 90.3%    |
| 申请书 tSQH          | 申请书\|申请\|情书                   | 89.7%      | 92.7%    |
| 授权委托书 tSQWTS    | 授权委托书\|委托书\|托书\|委托       | 93.5%      | 97.6%    |
| 调解书 tTJS          | 调解书\|调解\|解书                   | 89.8%      | 93.5%    |



### **4.2 预测发现的问题**

- 缺少顿号
- 0, 1总是预测不准【O. i, l】【0预测不出来，缺失】
- ?
- ,
- 祥， 媛-->缓
- 彧-->或
- 字太小的时候，导致切分不准确，会当成噪点，识别的结果完全乱码
- 很多汉字缺少
- 对图片的像素质量要求较高

#### **4.2.1** 标题分类出现问题

- 质量不好的图片，详见`H:\python-workspace\ocr_postcorrection\data\poor_data`

- 图片字太小，预测完全不准确, 切分的时候不够准确

  > 16_A49119E1-A80C-4EEF-A4DF-7D9D3358EDA1.jpg
  >
  > 1#20180821171300_001.jpg
  >
  > 16_A4DD4B33-B316-4B9C-A53D-A3C35997846A.jpg
  >
  > 16_CEF04511-8E03-49B8-8563-8D63A622D219.jpg

- 图片倾斜较严重
- 图片膨胀过后，字和字之间空隙太小

### **4.3 checkpoint备份**

~~~
H:\python-workspace\ocr_postcorrection\data\ckpts\all_3991_0415
~~~

### 4.4 方法

> 见147电脑， single_char_processing_0422.py, main函数改一下路径

- 预测结果，包括图片划分结果，预测文本数据，源数据与预测标签





## **5 训练结果**

![ ](https://raw.githubusercontent.com/yaolinxia/img_resource/master/multi-input attention/2019-04-17 22-02-37屏幕截图.png)

![ ](https://raw.githubusercontent.com/yaolinxia/img_resource/master/multi-input attention/2019-04-22 14-27-56屏幕截图.png)

- **最高**89%



### 5.1 实验对比

| 阶段   | 总字数        | ours准确率 | ts准确率 | ours速度 | ts速度 |
| ------ | ------------- | ---------- | -------- | -------- | ------ |
| 之前   | 8135（21p）   | 92.18%     | 85.8%    | 156      | 309    |
| stage1 | 40745（100P） | 93.68%     | 91.02%   | 213      | 401    |
| stage2 | 384（11P）    | 97.38%     | 95.2%    | 142      | 292    |

> 没看完，再看一点

## 6 相关问题

1. **Nonetype**

   ![ ](https://raw.githubusercontent.com/yaolinxia/img_resource/master/multi-input attention/Nonetype问题.jpg)

   **解决方法：**打印出目录，发现有一个不明文件，删掉之后解决

![ ](https://raw.githubusercontent.com/yaolinxia/img_resource/master/multi-input attention/2019-04-25 21-33-31屏幕截图.png)

**解决方法**

- 加入了一行

![ ](https://raw.githubusercontent.com/yaolinxia/img_resource/master/multi-input attention/2019-04-25 22-21-29屏幕截图_WPS图片.png)



- 产生了新的问题

![ ](https://raw.githubusercontent.com/yaolinxia/img_resource/master/multi-input attention/2019-04-25 22-18-02屏幕截图.png)

- 解决， unmap函数出现问题，instance( )中的str改成了np.int64

# **二、训练二阶段**

## **1 数据**

### **1.1 汉字**

3900个常用汉字，其中包括一个空格

|        | 最常用字       | 较常用字       | 最不常用字     | 总数    |
| ------ | -------------- | -------------- | -------------- | ------- |
| 总数   | 1000           | 1000           | 1900           |         |
| 训练集 | 2000*1000(62M) | 1500*1000(47M) | 1000*1900()    | 5400000 |
| 测试集 | 200*1000(6.2M) | 150*1000(4.7M) | 100*1900(5.9M) | 540000  |

### **1.2 标点符号**

| 总数 | 训练集  | 测试集 |
| ---- | ------- | :----- |
| 29   | 29*2000 | 29*100 |
|      | 58000   | 2900   |

### **1.3 数字字母**

| 总数 | 训练集  | 测试集 |
| ---- | ------- | :----- |
| 62   | 62*2000 | 62*100 |
|      | 124000  | 6200   |

### **1.4 总数据**

训练集：5400000+58000+124000= 5582000

测试集：540000+2900+6200 = 549100



### 1.5 **卷宗数据**

| 名称                 | 数量 |
| -------------------- | ---- |
| 宣判笔录 tXPBL       | 1010 |
| 律师事务所函 tLSSWSH | 410  |
| 授权委托书 tSQWTS    | 1000 |
| 调解书tTjS           | 800  |
| 裁定书tCDS           | 800  |
| 17篇，最早           | 2500 |
| 盗窃罪               | --   |



## **2 数据存放**

- 38服务器 290端口
- /usr/local/src/data/stage3/all_7097

## **3 模型结构**

| **Layer**          | **1**                         | **2** | **3** | **4** | 全连接层 | 逻辑层    |
| ------------------ | ----------------------------- | ----- | ----- | ----- | -------- | --------- |
| **inputs**         | 64*64                         |       |       |       |          |           |
| filters            | 32                            | 64    | 128   | 256   |          |           |
| kernel_size        | 3                             |       |       |       |          |           |
| padding            | same                          |       |       |       |          |           |
| kernel_initializer | tf.glorot_uniform_initializer |       |       |       |          |           |
| 归一化             | batch_normalization           |       |       |       |          |           |
| 激活               | leaky_relu                    |       |       |       |          |           |
| 池化               | pool_size=[2, 2], strides=2   |       |       |       |          |           |
| units              |                               |       |       |       | 8192     | num_class |
|                    |                               |       |       |       |          |           |

## **4 模型预测**

### **4.1 预测数据**

**147电脑上**：/usr/local/src/data/test_data/test_data/input_data

- 8张像素较好的的图片

- 预测结果在：/usr/local/src/data/test_data/test_data/output_data

  > 结果包含，预测生成的文本，每个字，预测的概率值

### **4.2 预测发现的问题**

- 

### **4.3 checkpoint备份**

```
H:\python-workspace\ocr_postcorrection\data\ckpts\all_7097_0428
```

~~~
147电脑： /usr/local/src/data/stage4
~~~



## **5 训练结果**

![ ](https://raw.githubusercontent.com/yaolinxia/img_resource/master/multi-input attention/2019-05-09 21-37-35屏幕截图.png)



## **6 相关问题**





# **附件**

## **卷宗数据**

| (2014)津高刑二终字第0037号     | 157    | 206.8M     |
| ------------------------------ | ------ | ---------- |
| **(2015)津高审刑监字第0004号** | **68** | **138.1M** |
| **(2015)津高审刑监字第0028号** | 101    | 198.0M     |
|                                |        |            |

